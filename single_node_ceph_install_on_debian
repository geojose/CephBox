// Ceph installation on Debian //

Min requirement - Deploy an instance of debian (bookworm)
                - Add atleast one disk for osd deployment


admin@ip-172-31-51-235:~$ curl --silent --remote-name --location https://download.ceph.com/rpm-reef/el9/noarch/cephadm

admin@ip-172-31-51-235:~$ chmod +x cephadm 

admin@ip-172-31-51-235:~$ sudo ./cephadm add-repo --version 18.2.4
Installing repo GPG key from https://download.ceph.com/keys/release.gpg...
Installing repo file at /etc/apt/sources.list.d/ceph.list...
Updating package list...
Completed adding repo.
admin@ip-172-31-51-235:~$ sudo su
root@ip-172-31-51-235:/home/admin# cp ./cephadm /sbin/
root@ip-172-31-51-235:/home/admin# cd
root@ip-172-31-51-235:~# cephadm version
cephadm version 18.2.4 (e7ad5345525c7aa95470c26863873b581076945d) reef (stable)
      
root@ip-172-31-51-235:~# apt update 
Get:1 file:/etc/apt/mirrors/debian.list Mirrorlist [38 B]
Get:2 file:/etc/apt/mirrors/debian-security.list Mirrorlist [47 B]
Hit:3 https://cdn-aws.deb.debian.org/debian bookworm InRelease
Hit:4 https://cdn-aws.deb.debian.org/debian bookworm-updates InRelease
Hit:5 https://cdn-aws.deb.debian.org/debian bookworm-backports InRelease 
Hit:6 https://cdn-aws.deb.debian.org/debian-security bookworm-security InRelease
Hit:7 https://download.ceph.com/debian-18.2.4 bookworm InRelease         
Reading package lists... Done                      
Building dependency tree... Done
Reading state information... Done
35 packages can be upgraded. Run 'apt list --upgradable' to see them.

root@ip-172-31-51-235:~# apt install podman
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  aardvark-dns buildah catatonit conmon containernetworking-plugins crun dbus-user-session dirmngr fuse-overlayfs fuse3 gnupg gnupg-l10n gnupg-utils golang-github-containers-common
  golang-github-containers-image gpg gpg-agent gpg-wks-client gpg-wks-server gpgconf gpgsm libassuan0 libgpgme11 libksba8 libnpth0 libslirp0 libsubid4 libyajl2 netavark pinentry-curses
  slirp4netns uidmap
Suggested packages:
  containers-storage pinentry-gnome3 tor parcimonie xloadimage scdaemon pinentry-doc docker-compose
The following NEW packages will be installed:
  aardvark-dns buildah catatonit conmon containernetworking-plugins crun dbus-user-session dirmngr fuse-overlayfs fuse3 gnupg gnupg-l10n gnupg-utils golang-github-containers-common
  golang-github-containers-image gpg gpg-agent gpg-wks-client gpg-wks-server gpgconf gpgsm libassuan0 libgpgme11 libksba8 libnpth0 libslirp0 libsubid4 libyajl2 netavark pinentry-curses
  podman slirp4netns uidmap
0 upgraded, 33 newly installed, 0 to remove and 35 not upgraded.
Need to get 34.9 MB of archives.
After this operation, 131 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 file:/etc/apt/mirrors/debian.list Mirrorlist [38 B]
Get:2 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 netavark amd64 1.4.0-3 [1036 kB]
Get:3 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 aardvark-dns amd64 1.4.0-3 [767 kB]
Get:4 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 libsubid4 amd64 1:4.13+dfsg1-1+b1 [211 kB]
Get:5 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 uidmap amd64 1:4.13+dfsg1-1+b1 [189 kB]
Get:6 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 containernetworking-plugins amd64 1.1.1+ds1-3+b5 [6769 kB]
Get:7 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 golang-github-containers-image all 5.23.1-4 [31.7 kB]
Get:8 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 golang-github-containers-common all 0.50.1+ds1-4 [36.2 kB]
Get:9 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 libassuan0 amd64 2.5.5-5 [48.5 kB]
Get:10 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gpgconf amd64 2.2.40-1.1 [564 kB]
Get:11 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 libksba8 amd64 1.6.3-2 [128 kB]
Get:12 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 libnpth0 amd64 1.6-3 [19.0 kB]
Get:13 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 dirmngr amd64 2.2.40-1.1 [792 kB]
Get:14 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gnupg-l10n all 2.2.40-1.1 [1093 kB]
Get:15 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gnupg-utils amd64 2.2.40-1.1 [927 kB]
Get:16 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gpg amd64 2.2.40-1.1 [949 kB]
Get:17 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 pinentry-curses amd64 1.2.1-1 [77.4 kB]
Get:18 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gpg-agent amd64 2.2.40-1.1 [695 kB]
Get:19 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gpg-wks-client amd64 2.2.40-1.1 [541 kB]
Get:20 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gpg-wks-server amd64 2.2.40-1.1 [531 kB]
Get:21 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gpgsm amd64 2.2.40-1.1 [671 kB]
Get:22 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 gnupg all 2.2.40-1.1 [846 kB]
Get:23 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 libgpgme11 amd64 1.18.0-3+b1 [300 kB]
Get:24 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 buildah amd64 1.28.2+ds1-3+b1 [6147 kB]
Get:25 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 catatonit amd64 0.1.7-1+b1 [264 kB]
Get:26 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 conmon amd64 2.1.6+ds1-1 [37.9 kB]
Get:27 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 libyajl2 amd64 2.1.0-3+deb12u2 [23.0 kB]
Get:28 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 crun amd64 1.8.1-1+deb12u1 [289 kB]
Get:29 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 dbus-user-session amd64 1.14.10-1~deb12u1 [78.1 kB]
Get:30 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 fuse3 amd64 3.14.0-4 [35.9 kB]
Get:31 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 fuse-overlayfs amd64 1.10-1 [43.5 kB]
Get:32 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 libslirp0 amd64 4.7.0-1 [63.0 kB]
Get:33 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 podman amd64 4.3.1+ds1-8+deb12u1 [10.7 MB]
Get:34 https://cdn-aws.deb.debian.org/debian bookworm/main amd64 slirp4netns amd64 1.2.0-1 [37.5 kB]
Fetched 34.9 MB in 0s (90.3 MB/s)        
Extracting templates from packages: 100%
Selecting previously unselected package netavark.
(Reading database ... 29493 files and directories currently installed.)
Preparing to unpack .../00-netavark_1.4.0-3_amd64.deb ...
Unpacking netavark (1.4.0-3) ...
Selecting previously unselected package aardvark-dns.
Preparing to unpack .../01-aardvark-dns_1.4.0-3_amd64.deb ...
Unpacking aardvark-dns (1.4.0-3) ...
Selecting previously unselected package libsubid4:amd64.
Preparing to unpack .../02-libsubid4_1%3a4.13+dfsg1-1+b1_amd64.deb ...
Unpacking libsubid4:amd64 (1:4.13+dfsg1-1+b1) ...
Selecting previously unselected package uidmap.
Preparing to unpack .../03-uidmap_1%3a4.13+dfsg1-1+b1_amd64.deb ...
Unpacking uidmap (1:4.13+dfsg1-1+b1) ...
Selecting previously unselected package containernetworking-plugins.
Preparing to unpack .../04-containernetworking-plugins_1.1.1+ds1-3+b5_amd64.deb ...
Unpacking containernetworking-plugins (1.1.1+ds1-3+b5) ...
Selecting previously unselected package golang-github-containers-image.
Preparing to unpack .../05-golang-github-containers-image_5.23.1-4_all.deb ...
Unpacking golang-github-containers-image (5.23.1-4) ...
Selecting previously unselected package golang-github-containers-common.
Preparing to unpack .../06-golang-github-containers-common_0.50.1+ds1-4_all.deb ...
Unpacking golang-github-containers-common (0.50.1+ds1-4) ...
Selecting previously unselected package libassuan0:amd64.
Preparing to unpack .../07-libassuan0_2.5.5-5_amd64.deb ...
Unpacking libassuan0:amd64 (2.5.5-5) ...
Selecting previously unselected package gpgconf.
Preparing to unpack .../08-gpgconf_2.2.40-1.1_amd64.deb ...
Unpacking gpgconf (2.2.40-1.1) ...
Selecting previously unselected package libksba8:amd64.
Preparing to unpack .../09-libksba8_1.6.3-2_amd64.deb ...
Unpacking libksba8:amd64 (1.6.3-2) ...
Selecting previously unselected package libnpth0:amd64.
Preparing to unpack .../10-libnpth0_1.6-3_amd64.deb ...
Unpacking libnpth0:amd64 (1.6-3) ...
Selecting previously unselected package dirmngr.
Preparing to unpack .../11-dirmngr_2.2.40-1.1_amd64.deb ...
Unpacking dirmngr (2.2.40-1.1) ...
Selecting previously unselected package gnupg-l10n.
Preparing to unpack .../12-gnupg-l10n_2.2.40-1.1_all.deb ...
Unpacking gnupg-l10n (2.2.40-1.1) ...
Selecting previously unselected package gnupg-utils.
Preparing to unpack .../13-gnupg-utils_2.2.40-1.1_amd64.deb ...
Unpacking gnupg-utils (2.2.40-1.1) ...
Selecting previously unselected package gpg.
Preparing to unpack .../14-gpg_2.2.40-1.1_amd64.deb ...
Unpacking gpg (2.2.40-1.1) ...
Selecting previously unselected package pinentry-curses.
Preparing to unpack .../15-pinentry-curses_1.2.1-1_amd64.deb ...
Unpacking pinentry-curses (1.2.1-1) ...
Selecting previously unselected package gpg-agent.
Preparing to unpack .../16-gpg-agent_2.2.40-1.1_amd64.deb ...
Unpacking gpg-agent (2.2.40-1.1) ...
Selecting previously unselected package gpg-wks-client.
Preparing to unpack .../17-gpg-wks-client_2.2.40-1.1_amd64.deb ...
Unpacking gpg-wks-client (2.2.40-1.1) ...
Selecting previously unselected package gpg-wks-server.
Preparing to unpack .../18-gpg-wks-server_2.2.40-1.1_amd64.deb ...
Unpacking gpg-wks-server (2.2.40-1.1) ...
Selecting previously unselected package gpgsm.
Preparing to unpack .../19-gpgsm_2.2.40-1.1_amd64.deb ...
Unpacking gpgsm (2.2.40-1.1) ...
Selecting previously unselected package gnupg.
Preparing to unpack .../20-gnupg_2.2.40-1.1_all.deb ...
Unpacking gnupg (2.2.40-1.1) ...
Selecting previously unselected package libgpgme11:amd64.
Preparing to unpack .../21-libgpgme11_1.18.0-3+b1_amd64.deb ...
Unpacking libgpgme11:amd64 (1.18.0-3+b1) ...
Selecting previously unselected package buildah.
Preparing to unpack .../22-buildah_1.28.2+ds1-3+b1_amd64.deb ...
Unpacking buildah (1.28.2+ds1-3+b1) ...
Selecting previously unselected package catatonit.
Preparing to unpack .../23-catatonit_0.1.7-1+b1_amd64.deb ...
Unpacking catatonit (0.1.7-1+b1) ...
Selecting previously unselected package conmon.
Preparing to unpack .../24-conmon_2.1.6+ds1-1_amd64.deb ...
Unpacking conmon (2.1.6+ds1-1) ...
Selecting previously unselected package libyajl2:amd64.
Preparing to unpack .../25-libyajl2_2.1.0-3+deb12u2_amd64.deb ...
Unpacking libyajl2:amd64 (2.1.0-3+deb12u2) ...
Selecting previously unselected package crun.
Preparing to unpack .../26-crun_1.8.1-1+deb12u1_amd64.deb ...
Unpacking crun (1.8.1-1+deb12u1) ...
Selecting previously unselected package dbus-user-session.
Preparing to unpack .../27-dbus-user-session_1.14.10-1~deb12u1_amd64.deb ...
Unpacking dbus-user-session (1.14.10-1~deb12u1) ...
Selecting previously unselected package fuse3.
Preparing to unpack .../28-fuse3_3.14.0-4_amd64.deb ...
Unpacking fuse3 (3.14.0-4) ...
Selecting previously unselected package fuse-overlayfs.
Preparing to unpack .../29-fuse-overlayfs_1.10-1_amd64.deb ...
Unpacking fuse-overlayfs (1.10-1) ...
Selecting previously unselected package libslirp0:amd64.
Preparing to unpack .../30-libslirp0_4.7.0-1_amd64.deb ...
Unpacking libslirp0:amd64 (4.7.0-1) ...
Selecting previously unselected package podman.
Preparing to unpack .../31-podman_4.3.1+ds1-8+deb12u1_amd64.deb ...
Unpacking podman (4.3.1+ds1-8+deb12u1) ...
Selecting previously unselected package slirp4netns.
Preparing to unpack .../32-slirp4netns_1.2.0-1_amd64.deb ...
Unpacking slirp4netns (1.2.0-1) ...
Setting up libksba8:amd64 (1.6.3-2) ...
Setting up libyajl2:amd64 (2.1.0-3+deb12u2) ...
Setting up libnpth0:amd64 (1.6-3) ...
Setting up libassuan0:amd64 (2.5.5-5) ...
Setting up fuse3 (3.14.0-4) ...
update-initramfs: deferring update (trigger activated)
Setting up libsubid4:amd64 (1:4.13+dfsg1-1+b1) ...
Setting up dbus-user-session (1.14.10-1~deb12u1) ...
Setting up golang-github-containers-image (5.23.1-4) ...
Setting up gnupg-l10n (2.2.40-1.1) ...
Setting up conmon (2.1.6+ds1-1) ...
Setting up containernetworking-plugins (1.1.1+ds1-3+b5) ...
Setting up catatonit (0.1.7-1+b1) ...
Setting up netavark (1.4.0-3) ...
Setting up aardvark-dns (1.4.0-3) ...
Setting up libslirp0:amd64 (4.7.0-1) ...
Setting up gpgconf (2.2.40-1.1) ...
Setting up fuse-overlayfs (1.10-1) ...
Setting up golang-github-containers-common (0.50.1+ds1-4) ...
Setting up gpg (2.2.40-1.1) ...
Setting up gnupg-utils (2.2.40-1.1) ...
Setting up pinentry-curses (1.2.1-1) ...
Setting up gpg-agent (2.2.40-1.1) ...
Created symlink /etc/systemd/user/sockets.target.wants/gpg-agent-browser.socket → /usr/lib/systemd/user/gpg-agent-browser.socket.
Created symlink /etc/systemd/user/sockets.target.wants/gpg-agent-extra.socket → /usr/lib/systemd/user/gpg-agent-extra.socket.
Created symlink /etc/systemd/user/sockets.target.wants/gpg-agent-ssh.socket → /usr/lib/systemd/user/gpg-agent-ssh.socket.
Created symlink /etc/systemd/user/sockets.target.wants/gpg-agent.socket → /usr/lib/systemd/user/gpg-agent.socket.
Setting up slirp4netns (1.2.0-1) ...
Setting up crun (1.8.1-1+deb12u1) ...
Setting up uidmap (1:4.13+dfsg1-1+b1) ...
Setting up gpgsm (2.2.40-1.1) ...
Setting up libgpgme11:amd64 (1.18.0-3+b1) ...
Setting up dirmngr (2.2.40-1.1) ...
Created symlink /etc/systemd/user/sockets.target.wants/dirmngr.socket → /usr/lib/systemd/user/dirmngr.socket.
Setting up gpg-wks-server (2.2.40-1.1) ...
Setting up buildah (1.28.2+ds1-3+b1) ...
Setting up gpg-wks-client (2.2.40-1.1) ...
Setting up podman (4.3.1+ds1-8+deb12u1) ...
Created symlink /etc/systemd/system/default.target.wants/podman-auto-update.service → /lib/systemd/system/podman-auto-update.service.
Created symlink /etc/systemd/system/timers.target.wants/podman-auto-update.timer → /lib/systemd/system/podman-auto-update.timer.
Created symlink /etc/systemd/system/default.target.wants/podman-restart.service → /lib/systemd/system/podman-restart.service.
Created symlink /etc/systemd/system/default.target.wants/podman.service → /lib/systemd/system/podman.service.
Created symlink /etc/systemd/system/sockets.target.wants/podman.socket → /lib/systemd/system/podman.socket.
Setting up gnupg (2.2.40-1.1) ...
Processing triggers for libc-bin (2.36-9+deb12u7) ...
Processing triggers for man-db (2.11.2-2) ...
Processing triggers for initramfs-tools (0.142) ...
update-initramfs: Generating /boot/initrd.img-6.1.0-23-cloud-amd64

root@ip-172-31-51-235:~# podman pull quay.io/ceph/ceph:v18.2.4
Trying to pull quay.io/ceph/ceph:v18.2.4...
Getting image source signatures
Copying blob 676ca14fffd6 done  
Copying blob a0a261c93a1a done  
Copying config 2bc0b0f437 done  
Writing manifest to image destination
Storing signatures
2bc0b0f4375ddf4270a9a865dfd4e53063acc8e6c3afd7a2546507cafd2ec86a

root@ip-172-31-51-235:~# podman images
REPOSITORY         TAG         IMAGE ID      CREATED       SIZE
quay.io/ceph/ceph  v18.2.4     2bc0b0f4375d  2 months ago  1.25 GB

root@ip-172-31-51-235:~# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: enX0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 12:2b:43:77:40:77 brd ff:ff:ff:ff:ff:ff
    inet 172.31.51.235/20 metric 100 brd 172.31.63.255 scope global dynamic enX0
       valid_lft 3102sec preferred_lft 3102sec
    inet6 fe80::102b:43ff:fe77:4077/64 scope link 
       valid_lft forever preferred_lft forever

root@ip-172-31-51-235:~# cephadm --image quay.io/ceph/ceph:v18.2.4 bootstrap --mon-ip 172.31.51.235  --single-host-defaults
Creating directory /etc/ceph for ceph.conf
Verifying podman|docker is present...
Verifying lvm2 is present...
Installing packages ['lvm2']...
Verifying time synchronization is in place...
Unit systemd-timesyncd.service is enabled and running
Repeating the final host check...
podman (/usr/bin/podman) version 4.3.1 is present
systemctl is present
lvcreate is present
Unit systemd-timesyncd.service is enabled and running
Host looks OK
Cluster fsid: ccdeb860-8ef7-11ef-8454-122b43774077
Verifying IP 172.31.51.235 port 3300 ...
Verifying IP 172.31.51.235 port 6789 ...
Mon IP `172.31.51.235` is in CIDR network `172.31.48.0/20`
Mon IP `172.31.51.235` is in CIDR network `172.31.48.0/20`
Mon IP `172.31.51.235` is in CIDR network `172.31.48.1/32`
Mon IP `172.31.51.235` is in CIDR network `172.31.48.1/32`
Internal network (--cluster-network) has not been provided, OSD replication will default to the public_network
Adjusting default settings to suit single-host cluster...
Pulling container image quay.io/ceph/ceph:v18.2.4...
Ceph version: ceph version 18.2.4 (e7ad5345525c7aa95470c26863873b581076945d) reef (stable)
Extracting ceph user uid/gid from container image...
Creating initial keys...
Creating initial monmap...
Creating mon...
Waiting for mon to start...
Waiting for mon...
mon is available
Assimilating anything we can from ceph.conf...
Generating new minimal ceph.conf...
Restarting the monitor...
Setting public_network to 172.31.48.1/32,172.31.48.0/20 in mon config section
Wrote config to /etc/ceph/ceph.conf
Wrote keyring to /etc/ceph/ceph.client.admin.keyring
Creating mgr...
Verifying port 0.0.0.0:9283 ...
Verifying port 0.0.0.0:8765 ...
Verifying port 0.0.0.0:8443 ...
Waiting for mgr to start...
Waiting for mgr...
mgr not available, waiting (1/15)...
mgr not available, waiting (2/15)...
mgr not available, waiting (3/15)...
mgr is available
Enabling cephadm module...
Waiting for the mgr to restart...
Waiting for mgr epoch 5...
mgr epoch 5 is available
Setting orchestrator backend to cephadm...
Generating ssh key...
Wrote public SSH key to /etc/ceph/ceph.pub
Adding key to root@localhost authorized_keys...
Adding host ip-172-31-51-235...
Deploying mon service with default placement...
Deploying mgr service with default placement...
Deploying crash service with default placement...
Deploying ceph-exporter service with default placement...
Deploying prometheus service with default placement...
Deploying grafana service with default placement...
Deploying node-exporter service with default placement...
Deploying alertmanager service with default placement...
Enabling the dashboard module...
Waiting for the mgr to restart...
Waiting for mgr epoch 9...
mgr epoch 9 is available
Generating a dashboard self-signed certificate...
Creating initial admin user...
Fetching dashboard port number...
Ceph Dashboard is now available at:

	     URL: https://ip-172-31-51-235:8443/
	    User: admin
	Password: 9z3o5jrzqy

Enabling client.admin keyring and conf on hosts with "admin" label
Saving cluster configuration to /var/lib/ceph/ccdeb860-8ef7-11ef-8454-122b43774077/config directory
Enabling autotune for osd_memory_target
You can access the Ceph CLI as following in case of multi-cluster or non-default config:

	sudo /usr/sbin/cephadm shell --fsid ccdeb860-8ef7-11ef-8454-122b43774077 -c /etc/ceph/ceph.conf -k /etc/ceph/ceph.client.admin.keyring

Or, if you are only running a single cluster on this host:

	sudo /usr/sbin/cephadm shell 

Please consider enabling telemetry to help improve Ceph:

	ceph telemetry on

For more information see:

	https://docs.ceph.com/en/latest/mgr/telemetry/

Bootstrap complete.


root@ip-172-31-51-235:~# cephadm install ceph-common
Installing packages ['ceph-common']...


root@ip-172-31-51-235:~# ceph -s
  cluster:
    id:     ccdeb860-8ef7-11ef-8454-122b43774077
    health: HEALTH_WARN
            OSD count 0 < osd_pool_default_size 2
 
  services:
    mon: 1 daemons, quorum ip-172-31-51-235 (age 112s)
    mgr: ip-172-31-51-235.iypglb(active, since 30s), standbys: ip-172-31-51-235.qqfupu
    osd: 0 osds: 0 up, 0 in
 
  data:
    pools:   0 pools, 0 pgs
    objects: 0 objects, 0 B
    usage:   0 B used, 0 B / 0 B avail
    pgs:     
 
root@ip-172-31-51-235:~# lsblk 
NAME     MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
xvda     202:0    0   20G  0 disk 
├─xvda1  202:1    0 19.9G  0 part /var/lib/containers/storage/overlay
│                                 /
├─xvda14 202:14   0    3M  0 part 
└─xvda15 202:15   0  124M  0 part /boot/efi
xvdb     202:16   0   10G  0 disk 

root@ip-172-31-51-235:~# ceph orch apply osd --all-available-devices
Scheduled osd.all-available-devices update...
root@ip-172-31-51-235:~# ceph orch host ls
HOST              ADDR           LABELS  STATUS  
ip-172-31-51-235  172.31.51.235  _admin          
1 hosts in cluster

root@ip-172-31-51-235:~# ceph orch ps
NAME                            HOST              PORTS             STATUS         REFRESHED  AGE  MEM USE  MEM LIM  VERSION  IMAGE ID      CONTAINER ID  
alertmanager.ip-172-31-51-235   ip-172-31-51-235  *:9093,9094       running (2m)     32s ago   2m    15.5M        -  0.25.0   c8568f914cd2  8340d50d18bf  
ceph-exporter.ip-172-31-51-235  ip-172-31-51-235                    running (3m)     32s ago   3m    6233k        -  18.2.4   2bc0b0f4375d  db573dfc37af  
crash.ip-172-31-51-235          ip-172-31-51-235                    running (3m)     32s ago   3m    6891k        -  18.2.4   2bc0b0f4375d  609c5c18461d  
grafana.ip-172-31-51-235        ip-172-31-51-235  *:3000            running (2m)     32s ago   2m    77.1M        -  9.4.7    954c08fa6188  85ad4dd80998  
mgr.ip-172-31-51-235.iypglb     ip-172-31-51-235  *:9283,8765,8443  running (3m)     32s ago   3m     467M        -  18.2.4   2bc0b0f4375d  30dc824bac47  
mgr.ip-172-31-51-235.qqfupu     ip-172-31-51-235  *:8443,8765       running (2m)     32s ago   2m     430M        -  18.2.4   2bc0b0f4375d  1488c1114af2  
mon.ip-172-31-51-235            ip-172-31-51-235                    running (3m)     32s ago   3m    35.7M    2048M  18.2.4   2bc0b0f4375d  9833053dd9e7  
node-exporter.ip-172-31-51-235  ip-172-31-51-235  *:9100            running (2m)     32s ago   2m    15.6M        -  1.5.0    0da6a335fe13  c7032a68725d  
osd.0                           ip-172-31-51-235                    running (35s)    32s ago  35s    12.6M    4096M  18.2.4   2bc0b0f4375d  2b58b57faa19  
prometheus.ip-172-31-51-235     ip-172-31-51-235  *:9095            running (2m)     32s ago   2m    36.5M        -  2.43.0   a07b618ecd1d  8d75545b0c4f  

root@ip-172-31-51-235:~# ceph config set global mon_allow_pool_delete true

root@ip-172-31-51-235:~# ceph config set global osd_pool_default_min_size 1

root@ip-172-31-51-235:~# ceph config set global osd_pool_default_size 1


root@ip-172-31-51-235:~# radosgw-admin realm create --rgw-realm=test_realm --default
{
    "id": "b3ed3eb0-005a-41d7-98ba-0fc817069809",
    "name": "test_realm",
    "current_period": "5e1ae4ec-cd56-4b9a-8101-bf6b81462c64",
    "epoch": 1
}
root@ip-172-31-51-235:~# radosgw-admin zonegroup create --rgw-zonegroup=default --master --default
{
    "id": "dc1b3190-a2d8-4ff0-b450-68492dd066c8",
    "name": "default",
    "api_name": "default",
    "is_master": true,
    "endpoints": [],
    "hostnames": [],
    "hostnames_s3website": [],
    "master_zone": "",
    "zones": [],
    "placement_targets": [
        {
            "name": "default-placement",
            "tags": [],
            "storage_classes": []
        }
    ],
    "default_placement": "default-placement",
    "realm_id": "b3ed3eb0-005a-41d7-98ba-0fc817069809",
    "sync_policy": {
        "groups": []
    },
    "enabled_features": [
        "resharding"
    ]
}
root@ip-172-31-51-235:~# radosgw-admin zone create --rgw-zonegroup=default --rgw-zone=test_zone --master --default
{
    "id": "404a7b21-1db4-4126-82ba-5c3f4bff1e20",
    "name": "test_zone",
    "domain_root": "test_zone.rgw.meta:root",
    "control_pool": "test_zone.rgw.control",
    "gc_pool": "test_zone.rgw.log:gc",
    "lc_pool": "test_zone.rgw.log:lc",
    "log_pool": "test_zone.rgw.log",
    "intent_log_pool": "test_zone.rgw.log:intent",
    "usage_log_pool": "test_zone.rgw.log:usage",
    "roles_pool": "test_zone.rgw.meta:roles",
    "reshard_pool": "test_zone.rgw.log:reshard",
    "user_keys_pool": "test_zone.rgw.meta:users.keys",
    "user_email_pool": "test_zone.rgw.meta:users.email",
    "user_swift_pool": "test_zone.rgw.meta:users.swift",
    "user_uid_pool": "test_zone.rgw.meta:users.uid",
    "otp_pool": "test_zone.rgw.otp",
    "system_key": {
        "access_key": "",
        "secret_key": ""
    },
    "placement_pools": [
        {
            "key": "default-placement",
            "val": {
                "index_pool": "test_zone.rgw.buckets.index",
                "storage_classes": {
                    "STANDARD": {
                        "data_pool": "test_zone.rgw.buckets.data"
                    }
                },
                "data_extra_pool": "test_zone.rgw.buckets.non-ec",
                "index_type": 0,
                "inline_data": true
            }
        }
    ],
    "realm_id": "b3ed3eb0-005a-41d7-98ba-0fc817069809",
    "notif_pool": "test_zone.rgw.log:notif"
}
root@ip-172-31-51-235:~# radosgw-admin period update --rgw-realm=test_realm --commit
2024-10-20T15:35:59.080+0000 7f05a2222d40  0 period (5e1ae4ec-cd56-4b9a-8101-bf6b81462c64 does not have zone 404a7b21-1db4-4126-82ba-5c3f4bff1e20 configured
{
    "id": "46f8365f-4f26-4a10-9f04-05c1b0567beb",
    "epoch": 1,
    "predecessor_uuid": "5e1ae4ec-cd56-4b9a-8101-bf6b81462c64",
    "sync_status": [],
    "period_map": {
        "id": "46f8365f-4f26-4a10-9f04-05c1b0567beb",
        "zonegroups": [
            {
                "id": "dc1b3190-a2d8-4ff0-b450-68492dd066c8",
                "name": "default",
                "api_name": "default",
                "is_master": true,
                "endpoints": [],
                "hostnames": [],
                "hostnames_s3website": [],
                "master_zone": "404a7b21-1db4-4126-82ba-5c3f4bff1e20",
                "zones": [
                    {
                        "id": "404a7b21-1db4-4126-82ba-5c3f4bff1e20",
                        "name": "test_zone",
                        "endpoints": [],
                        "log_meta": false,
                        "log_data": false,
                        "bucket_index_max_shards": 11,
                        "read_only": false,
                        "tier_type": "",
                        "sync_from_all": true,
                        "sync_from": [],
                        "redirect_zone": "",
                        "supported_features": [
                            "compress-encrypted",
                            "resharding"
                        ]
                    }
                ],
                "placement_targets": [
                    {
                        "name": "default-placement",
                        "tags": [],
                        "storage_classes": [
                            "STANDARD"
                        ]
                    }
                ],
                "default_placement": "default-placement",
                "realm_id": "b3ed3eb0-005a-41d7-98ba-0fc817069809",
                "sync_policy": {
                    "groups": []
                },
                "enabled_features": [
                    "resharding"
                ]
            }
        ],
        "short_zone_ids": [
            {
                "key": "404a7b21-1db4-4126-82ba-5c3f4bff1e20",
                "val": 3443879503
            }
        ]
    },
    "master_zonegroup": "dc1b3190-a2d8-4ff0-b450-68492dd066c8",
    "master_zone": "404a7b21-1db4-4126-82ba-5c3f4bff1e20",
    "period_config": {
        "bucket_quota": {
            "enabled": false,
            "check_on_raw": false,
            "max_size": -1,
            "max_size_kb": 0,
            "max_objects": -1
        },
        "user_quota": {
            "enabled": false,
            "check_on_raw": false,
            "max_size": -1,
            "max_size_kb": 0,
            "max_objects": -1
        },
        "user_ratelimit": {
            "max_read_ops": 0,
            "max_write_ops": 0,
            "max_read_bytes": 0,
            "max_write_bytes": 0,
            "enabled": false
        },
        "bucket_ratelimit": {
            "max_read_ops": 0,
            "max_write_ops": 0,
            "max_read_bytes": 0,
            "max_write_bytes": 0,
            "enabled": false
        },
        "anonymous_ratelimit": {
            "max_read_ops": 0,
            "max_write_ops": 0,
            "max_read_bytes": 0,
            "max_write_bytes": 0,
            "enabled": false
        }
    },
    "realm_id": "b3ed3eb0-005a-41d7-98ba-0fc817069809",
    "realm_name": "test_realm",
    "realm_epoch": 2
}

root@ip-172-31-51-235:~# ceph orch host ls
HOST              ADDR           LABELS  STATUS  
ip-172-31-51-235  172.31.51.235  _admin          
1 hosts in cluster

root@ip-172-31-51-235:~# ceph orch apply rgw test --realm=test_realm --zone=test_zone --placement="1 ip-172-31-51-235"
Scheduled rgw.test update...

root@ip-172-31-51-235:~# ceph orch ps
NAME                              HOST              PORTS             STATUS         REFRESHED  AGE  MEM USE  MEM LIM  VERSION  IMAGE ID      CONTAINER ID  
alertmanager.ip-172-31-51-235     ip-172-31-51-235  *:9093,9094       running (8m)     11s ago   9m    22.1M        -  0.25.0   c8568f914cd2  8340d50d18bf  
ceph-exporter.ip-172-31-51-235    ip-172-31-51-235                    running (9m)     11s ago   9m    7226k        -  18.2.4   2bc0b0f4375d  db573dfc37af  
crash.ip-172-31-51-235            ip-172-31-51-235                    running (9m)     11s ago   9m    6891k        -  18.2.4   2bc0b0f4375d  609c5c18461d  
grafana.ip-172-31-51-235          ip-172-31-51-235  *:3000            running (8m)     11s ago   8m    83.4M        -  9.4.7    954c08fa6188  85ad4dd80998  
mgr.ip-172-31-51-235.iypglb       ip-172-31-51-235  *:9283,8765,8443  running (10m)    11s ago  10m     480M        -  18.2.4   2bc0b0f4375d  30dc824bac47  
mgr.ip-172-31-51-235.qqfupu       ip-172-31-51-235  *:8443,8765       running (8m)     11s ago   8m     432M        -  18.2.4   2bc0b0f4375d  1488c1114af2  
mon.ip-172-31-51-235              ip-172-31-51-235                    running (10m)    11s ago  10m    38.8M    2048M  18.2.4   2bc0b0f4375d  9833053dd9e7  
node-exporter.ip-172-31-51-235    ip-172-31-51-235  *:9100            running (9m)     11s ago   9m    15.7M        -  1.5.0    0da6a335fe13  c7032a68725d  
osd.0                             ip-172-31-51-235                    running (6m)     11s ago   6m    55.5M    4096M  18.2.4   2bc0b0f4375d  2b58b57faa19  
prometheus.ip-172-31-51-235       ip-172-31-51-235  *:9095            running (8m)     11s ago   8m    43.1M        -  2.43.0   a07b618ecd1d  8d75545b0c4f  
rgw.test.ip-172-31-51-235.hwzops  ip-172-31-51-235  *:80              running (13s)    11s ago  13s    73.5M        -  18.2.4   2bc0b0f4375d  6708d903a608  

root@ip-172-31-51-235:~# radosgw-admin user create --uid="s3user" --display-name="S3 user" --email="s3user@example.com"
{
    "user_id": "s3user",
    "display_name": "S3 user",
    "email": "s3user@example.com",
    "suspended": 0,
    "max_buckets": 1000,
    "subusers": [],
    "keys": [
        {
            "user": "s3user",
            "access_key": "EZSREAQ0C23ZO40B3I17",
            "secret_key": "EUdx9yXxvfuMv8Z2iBiUPcuZShVqR83ZC0ve1QDL"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "default_storage_class": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": 0,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": 0,
        "max_objects": -1
    },
    "temp_url_keys": [],
    "type": "rgw",
    "mfa_ids": []
}

root@ip-172-31-51-235:~# s3cmd --configure 
Enter new values or accept defaults in brackets with Enter.
Refer to user manual for detailed description of all options.
Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.
Access Key: EZSREAQ0C23ZO40B3I17
Secret Key: EUdx9yXxvfuMv8Z2iBiUPcuZShVqR83ZC0ve1QDL
Default Region [US]: 
Use "s3.amazonaws.com" for S3 Endpoint and not modify it to the target Amazon S3.
S3 Endpoint [s3.amazonaws.com]: 172.31.51.235:80
Use "%(bucket)s.s3.amazonaws.com" to the target Amazon S3. "%(bucket)s" and "%(location)s" vars can be used
if the target S3 system supports dns based buckets.
DNS-style bucket+hostname:port template for accessing a bucket [%(bucket)s.s3.amazonaws.com]: 172.31.51.235:80
Encryption password is used to protect your files from reading
by unauthorized persons while in transfer to S3
Encryption password: 
Path to GPG program [/usr/bin/gpg]: 
When using secure HTTPS protocol all communication with Amazon S3
servers is protected from 3rd party eavesdropping. This method is
slower than plain HTTP, and can only be proxied with Python 2.7 or newer
Use HTTPS protocol [Yes]: no
On some networks all internet access must go through a HTTP proxy.
Try setting it here if you can't connect to S3 directly
HTTP Proxy server name: 
New settings:
  Access Key: EZSREAQ0C23ZO40B3I17
  Secret Key: EUdx9yXxvfuMv8Z2iBiUPcuZShVqR83ZC0ve1QDL
  Default Region: US
  S3 Endpoint: 172.31.51.235:80
  DNS-style bucket+hostname:port template for accessing a bucket: 172.31.51.235:80
  Encryption password: 
  Path to GPG program: /usr/bin/gpg
  Use HTTPS protocol: False
  HTTP Proxy server name: 
  HTTP Proxy server port: 0
Test access with supplied credentials? [Y/n] n

Save settings? [y/N] y
Configuration saved to '/root/.s3cfg'


root@ip-172-31-51-235:~# s3cmd ls
root@ip-172-31-51-235:~# s3cmd mb s3:///homebucket
Bucket 's3://homebucket/' created


root@ip-172-31-51-235:~# s3cmd ls
2024-10-20 15:50  s3://homebucket
